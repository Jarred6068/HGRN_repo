---
title: "Identifying Transcription Factor Regulatory Programs Driving Hepatocyte Cell Differentiation "
author: "Audrey Fu Lab"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document: default
always_allow_html: true
bibliography: C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_1_27_2025/report_refs.bib
number_sections: false
---

```{r setup, include=FALSE}

library(ggplot2)
library(ggthemes)
library(ggpubr)
library(latex2exp)
library(gridExtra)
library(knitr)
library(kableExtra)
library(dplyr)
library(data.table)
library(corrplot)
library(pheatmap)
library(RColorBrewer)
library(NMI)
library(ggsci)
library(data.table)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.pos = 'H')

data = 'C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_2_13_2025/Output/applications/REGULON_DM_imputed_corr/'
savepath = 'C:/Users/Bruin/OneDrive/Documents/GitHub/Doctoral_Thesis/Figures/hcd/'

path_raa = 'C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_2_13_2025/Output/applications/REGULON_DM/'
path_raa2 = 'C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_2_13_2025/Output/applications/REGULON_DM_imputed2/'
path_raa3 = 'C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_2_13_2025/Output/applications/REGULON_DM_imputed3/'
path_raa4 = 'C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_2_13_2025/Output/applications/REGULON_DM_imputed4/'
path_raa5 = 'C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Reports/Report_2_13_2025/Output/applications/REGULON_DM_imputed_corr/'
savepath = 'C:/Users/Bruin/OneDrive/Documents/GitHub/Doctoral_Thesis/Figures/hcd/'

#regulon_activity = fread('C:/Users/Bruin/OneDrive/Documents/GitHub/HGRN_repo/Simulated Hierarchies/DATA/Applications/Regulon_DMcells_filtered80.csv')

#stdata = fread(paste0(path_raa, 'data_top_sorted.csv'))
#smdata = fread(paste0(path_raa, 'data_mid_sorted.csv'))


#rcdata = fread(paste0(path_rsca, 'data_top_sorted.csv'))

```


## Imputation with LATE

We apply LATE to the regulon activity matrix, treating genes as features and cells as observations. The model architecture consists of two encoder and two decoder layers, with an encoder size of 128, a bottleneck dimension of 64, and LeakyReLU activation. We train LATE using 70\% of cells for training, 15\% for testing, and 15\% for validation. We trained LATE for approximately 35 epochs, stopping when the validation loss curve began to rise above the training loss curve, to avoid overfitting  



## Clusters Using Imputed Data: Setting 1
In this example I apply HCD to the imputed regulon data with the following settings

| Parameter | Value |
| --- | --- |
| Encoder/Decoder Size | 256, 128 |
| Attention Heads | 5 |
| Kappa Method | Silouette |
| Input Graph Correlation Threshold | r = 0.2 |
|\(\gamma \) | 1 |
|\(\delta \) | 1 |
|\(\lambda \) | 1,1 |
| Patience | 20 |
| Batch Size | 64 |
| Max Epochs | 500 |
| final loss | 362.12 | 


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}


stdata.imp1 = fread(paste0(path_raa2, 'data_top_sorted.csv'))
smdata.imp1 = fread(paste0(path_raa2, 'data_mid_sorted.csv'))



gl = fread(paste0(path_raa2, 'gene_data.csv'))

# Calculate correlation matrix
cm = cor(t(stdata.imp1[,-c(1:3)]), method = 'spearman')
rownames(cm) = stdata.imp1$`Gene Label`
colnames(cm) = stdata.imp1$`Gene Label`


#hist(cm[upper.tri(cm)], main = "Histogram of Absolute Pairwise Correlations")


# Create annotation data frames
#row_annotation = data.frame(`Regulon Mid` = paste(paste('TF Group', smdata.corr$Cluster+1), ' '))
#rownames(row_annotation) = smdata.corr$Gene.Label  # This is the critical fix
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}
lbs = paste(paste('TF Group', 1:length(unique(stdata.imp1$Cluster+1))), ' ')
# Create annotation data frames
col_annotation = data.frame(Modules = paste(paste('TF Group', stdata.imp1$Cluster+1), ' '))
rownames(col_annotation) = stdata.imp1$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = pal_jco()(length(unique(stdata.imp1$Cluster+1)))
names(clust.cols) = lbs

#clust.cols2 = rainbow(length(unique(smdata.corr$Cluster)))
#names(clust.cols2) = paste(paste('TF Group', unique(smdata.corr$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)#, `Regulon Mid` = clust.cols2)

# Create heatmap with annotations
pheatmap(
  cm,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = col_annotation,
  annotation_col = col_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 22,
  annotation_legend = T,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 14,
  fontsize_row = 12,
  main = 'Regulon Activity Correlation Matrix',
  #filename = paste0(savepath, 'pheatmap_top_layer_DM_imputed.pdf')
)

```





```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

# Calculate correlation matrix
cm = cor(t(smdata.imp1[,-c(1:3)]), method = 'spearman')
rownames(cm) = smdata.imp1$`Gene Label`
colnames(cm) = smdata.imp1$`Gene Label`

# Create annotation data frames
row_annotation = data.frame(Modules = paste(paste('TF Group', smdata.imp1$Cluster+1), ' '))
rownames(row_annotation) = smdata.imp1$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = rainbow(length(unique(smdata.imp1$Cluster+1)))
names(clust.cols) = paste(paste('TF Group', unique(smdata.imp1$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)

# Create heatmap with annotations
pheatmap(
  cm,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = row_annotation,
  annotation_col = row_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 30,
  annotation_legend = TRUE,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 18,
  fontsize_row = 12,
  main = 'Regulon Activity Correlation Matrix',
  #filename = paste0(savepath, 'pheatmap_mid_layer_DM_imputed.pdf')
)

```


## Clusters Using Imputed Data: Setting 2
In this example I apply HCD to the imputed regulon data with the following settings

| Parameter | Value |
| --- | --- |
| Encoder/Decoder Size | 256, 128 |
| Attention Heads | 5 |
| Kappa Method | Bethe Hessian |
| Input Graph Correlation Threshold | r = 0.7 |
|\(\gamma \) | 1 |
|\(\delta \) | 1 |
|\(\lambda \) | 0.01, 0.01 |
| Patience | 10 |
| Batch Size | 16 |
| Max Epochs | 500 |
| final loss | 38.78 |


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}


stdata.imp2 = fread(paste0(path_raa3, 'data_top_sorted.csv'))
smdata.imp2 = fread(paste0(path_raa3, 'data_mid_sorted.csv'))



gl = fread(paste0(path_raa3, 'gene_data.csv'))

# Calculate correlation matrix
cm2 = cor(t(stdata.imp2[,-c(1:3)]), method = 'spearman')
rownames(cm2) = stdata.imp2$`Gene Label`
colnames(cm2) = stdata.imp2$`Gene Label`


#hist(cm[upper.tri(cm)], main = "Histogram of Absolute Pairwise Correlations")


# Create annotation data frames
#row_annotation = data.frame(`Regulon Mid` = paste(paste('TF Group', smdata.corr$Cluster+1), ' '))
#rownames(row_annotation) = smdata.corr$Gene.Label  # This is the critical fix
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}
lbs = paste(paste('TF Group', 1:length(unique(stdata.imp2$Cluster+1))), ' ')
# Create annotation data frames
col_annotation = data.frame(Modules = paste(paste('TF Group', stdata.imp2$Cluster+1), ' '))
rownames(col_annotation) = stdata.imp2$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = pal_jco()(length(unique(stdata.imp2$Cluster+1)))
names(clust.cols) = lbs

#clust.cols2 = rainbow(length(unique(smdata.corr$Cluster)))
#names(clust.cols2) = paste(paste('TF Group', unique(smdata.corr$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)#, `Regulon Mid` = clust.cols2)

# Create heatmap with annotations
pheatmap(
  cm2,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = col_annotation,
  annotation_col = col_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 22,
  annotation_legend = T,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 14,
  fontsize_row = 12,
  main = 'Regulon Activity Correlation Matrix',
  #filename = paste0(savepath, 'pheatmap_top_layer_DM_imputed.pdf')
)

```





```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

# Calculate correlation matrix
cm = cor(t(smdata.imp2[,-c(1:3)]), method = 'spearman')
rownames(cm) = smdata.imp2$`Gene Label`
colnames(cm) = smdata.imp2$`Gene Label`

# Create annotation data frames
row_annotation = data.frame(Modules = paste(paste('TF Group', smdata.imp2$Cluster+1), ' '))
rownames(row_annotation) = smdata.imp2$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = rainbow(length(unique(smdata.imp2$Cluster+1)))
names(clust.cols) = paste(paste('TF Group', unique(smdata.imp2$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)

# Create heatmap with annotations
pheatmap(
  cm,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = row_annotation,
  annotation_col = row_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 30,
  annotation_legend = TRUE,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 18,
  fontsize_row = 12,
  main = 'Regulon Activity Correlation Matrix',
  #filename = paste0(savepath, 'pheatmap_mid_layer_DM_imputed.pdf')
)

```






## Clusters Using Imputed Data: Setting 3
In this example I apply HCD to the imputed regulon data with the following settings

| Parameter | Value |
| --- | --- |
| Encoder/Decoder Size | 256, 128 |
| Attention Heads | 5 |
| Kappa Method | Bethe Hessian |
| Input Graph Correlation Threshold | r = 0.6 |
|\(\gamma \) | 1 |
|\(\delta \) | 1 |
|\(\lambda \) | 0.01, 0.01 |
| Patience | 10 |
| Batch Size | 16 |
| Max Epochs | 500 |
| final loss | 39.19 |


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}


stdata.imp3 = fread(paste0(path_raa4, 'data_top_sorted.csv'))
smdata.imp3 = fread(paste0(path_raa4, 'data_mid_sorted.csv'))



gl = fread(paste0(path_raa4, 'gene_data.csv'))

# Calculate correlation matrix
cm2 = cor(t(stdata.imp3[,-c(1:3)]), method = 'spearman')
rownames(cm2) = stdata.imp3$`Gene Label`
colnames(cm2) = stdata.imp3$`Gene Label`


#hist(cm[upper.tri(cm)], main = "Histogram of Absolute Pairwise Correlations")


# Create annotation data frames
#row_annotation = data.frame(`Regulon Mid` = paste(paste('TF Group', smdata.corr$Cluster+1), ' '))
#rownames(row_annotation) = smdata.corr$Gene.Label  # This is the critical fix
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}
lbs = paste(paste('TF Group', 1:length(unique(stdata.imp3$Cluster+1))), ' ')
# Create annotation data frames
col_annotation = data.frame(Modules = paste(paste('TF Group', stdata.imp3$Cluster+1), ' '))
rownames(col_annotation) = stdata.imp3$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = pal_jco()(length(unique(stdata.imp3$Cluster+1)))
names(clust.cols) = lbs

#clust.cols2 = rainbow(length(unique(smdata.corr$Cluster)))
#names(clust.cols2) = paste(paste('TF Group', unique(smdata.corr$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)#, `Regulon Mid` = clust.cols2)

# Create heatmap with annotations
pheatmap(
  cm2,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = col_annotation,
  annotation_col = col_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 22,
  annotation_legend = T,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 14,
  fontsize_row = 12,
  main = 'Regulon Activity Correlation Matrix',
  #filename = paste0(savepath, 'pheatmap_top_layer_DM_imputed.pdf')
)

```





```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

# Calculate correlation matrix
cm = cor(t(smdata.imp3[,-c(1:3)]), method = 'spearman')
rownames(cm) = smdata.imp3$`Gene Label`
colnames(cm) = smdata.imp3$`Gene Label`

# Create annotation data frames
row_annotation = data.frame(Modules = paste(paste('TF Group', smdata.imp3$Cluster+1), ' '))
rownames(row_annotation) = smdata.imp3$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = rainbow(length(unique(smdata.imp3$Cluster+1)))
names(clust.cols) = paste(paste('TF Group', unique(smdata.imp3$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)

# Create heatmap with annotations
pheatmap(
  cm,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = row_annotation,
  annotation_col = row_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 30,
  annotation_legend = TRUE,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 18,
  fontsize_row = 12,
  main = 'Regulon Activity Correlation Matrix',
  #filename = paste0(savepath, 'pheatmap_mid_layer_DM_imputed.pdf')
)

```







## Clusters Using Imputed Data with correlations as input: Setting 4
In this example I apply HCD to the imputed regulon data with the following settings

| Parameter | Value |
| --- | --- |
| Encoder/Decoder Size | 256, 128 |
| Attention Heads | 5 |
| Kappa Method | Bethe Hessian |
| Input Graph Correlation Threshold | r = 0.2 |
|\(\gamma \) | 1 |
|\(\delta \) | 1 |
|\(\lambda \) | 1, 1 |
| Patience | 10 |
| Batch Size | 16 |
| Max Epochs | 500 |
| final loss | 1116.54 |


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}


stdata.corr = fread(paste0(path_raa5, 'data_top_sorted.csv'))
smdata.corr = fread(paste0(path_raa5, 'data_mid_sorted.csv'))



gl = fread(paste0(path_raa5, 'gene_data.csv'))

# Calculate correlation matrix
cm.corr = cor(t(stdata.corr[,-c(1:3)]), method = 'spearman')
rownames(cm.corr) = stdata.corr$`Gene Label`
colnames(cm.corr) = stdata.corr$`Gene Label`


#hist(cm[upper.tri(cm)], main = "Histogram of Absolute Pairwise Correlations")


ix.singletons = which(gl$Middle.Assignment %in% c(54, 77, 95,96,97, 102))

xx = smdata.corr[which(smdata.corr$`Gene Label` %in% gl$TF_gene[ix.singletons]),]

# Create annotation data frames
#row_annotation = data.frame(`Regulon Mid` = paste(paste('TF Group', smdata.corr$Cluster+1), ' '))
#rownames(row_annotation) = smdata.corr$Gene.Label  # This is the critical fix
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}
lbs = paste(paste('TF Group', 1:length(unique(stdata.corr$Cluster+1))), ' ')
# Create annotation data frames
col_annotation = data.frame(Modules = paste(paste('TF Group', stdata.corr$Cluster+1), ' '))
rownames(col_annotation) = stdata.corr$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = pal_jco()(length(unique(stdata.corr$Cluster+1)))
names(clust.cols) = lbs

#clust.cols2 = rainbow(length(unique(smdata.corr$Cluster)))
#names(clust.cols2) = paste(paste('TF Group', unique(smdata.corr$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)#, `Regulon Mid` = clust.cols2)

# Create heatmap with annotations
gb1 = pheatmap(
  cm.corr,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = col_annotation,
  annotation_col = col_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 15,
  annotation_legend = T,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 14,
  fontsize_row = 12,
  main = 'Top Layer Parititon',
  filename = paste0(savepath, 'pheatmap_top_layer_DM_imputed_corr.pdf')
)

```





```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

# Calculate correlation matrix
cm = cor(t(smdata.corr[,-c(1:3)]), method = 'spearman')
rownames(cm) = smdata.corr$`Gene Label`
colnames(cm) = smdata.corr$`Gene Label`

# Create annotation data frames
row_annotation = data.frame(Modules = paste(paste('TF Group', smdata.corr$Cluster+1), ' '))
rownames(row_annotation) = smdata.corr$`Gene Label`  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = c(rep(brewer.pal(n = length(unique(smdata.corr$Cluster+1)), name = 'Accent'), 3), brewer.pal(n = 3, name = 'Accent'))
names(clust.cols) = paste(paste('TF Group', unique(smdata.corr$Cluster+1)), ' ')
# Define colors for clusters
annotation_colors = list(Modules = clust.cols)

# Create heatmap with annotations
gb2 = pheatmap(
  cm,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = row_annotation,
  annotation_col = row_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 15,
  annotation_legend = TRUE,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 12,
  fontsize_row = 12,
  main = 'Middle Layer Parition',
  filename = paste0(savepath, 'pheatmap_mid_layer_DM_imputed_corr.pdf')

)







```





## Clustering result using kmeans

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

# Calculate correlation matrix
cm = cor(t(stdata.imp1[,-c(1:3)]))

result = kmeans(stdata.imp1[,-c(1:3)], centers = 4)

clusts = result$cluster

idx = sort(clusts, index.return = T)$ix

dat = cm[idx, idx]
colnames(dat) = stdata.imp1$`Gene Label`[idx]
row.names(dat) = stdata.imp1$`Gene Label`[idx]

Cluster = clusts[idx]

# Create annotation data frames
row_annotation = data.frame(Regulon = paste(paste('TF Group', Cluster), ' '))
rownames(row_annotation) = stdata.imp1$`Gene Label`[idx]  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = pal_jco()(length(unique(Cluster)))
names(clust.cols) = paste(paste('TF Group', 1:length(unique(Cluster))), ' ')
# Define colors for clusters
annotation_colors = list(Regulon = clust.cols)

# Create heatmap with annotations
pheatmap(
  dat,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = row_annotation,
  annotation_col = row_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 30,
  annotation_legend = T,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 18,
  fontsize_row = 12,
  main = 'Regulon activity correlation matrix: Kmeans Clustering',
  #filename = paste0(savepath, 'pheatmap_kmeans_top_layer_DM_imputed.pdf')
)

```







## Clustering result using hierarchical clustering


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

# Calculate correlation matrix
cm = cor(t(stdata.corr[,-c(1:3)]))


h = hclust(dist(stdata.corr[,-c(1:3)], method = 'euclidean'), method = 'ward.D')

clusts <- cutree(h, k = 5)

idx = sort(clusts, index.return = T)$ix

dat = cm[idx, idx]
colnames(dat) = stdata.imp1$`Gene Label`[idx]
row.names(dat) = stdata.imp1$`Gene Label`[idx]

Cluster = clusts[idx]

# Create annotation data frames
row_annotation = data.frame(Regulon = paste(paste('TF Group', Cluster), ' '))
rownames(row_annotation) = stdata.imp1$`Gene Label`[idx]  # This is the critical fix


#clust.cols = colorRampPalette(brewer.pal(n = 10, name =""))
clust.cols = pal_jco()(length(unique(Cluster)))
names(clust.cols) = paste(paste('TF Group', 1:length(unique(Cluster))), ' ')
# Define colors for clusters
annotation_colors = list(Regulon = clust.cols)

# Create heatmap with annotations
pheatmap(
  dat,
  cluster_rows = FALSE, 
  cluster_cols = FALSE,
  color = colorRampPalette(brewer.pal(n = 10, name ="PRGn"))(100),  # Fixed color palette syntax
  annotation_row = row_annotation,
  annotation_col = row_annotation,
  annotation_colors = annotation_colors,
  annotation_names_col = FALSE,
  annotation_names_row = FALSE,
  show_rownames = FALSE,  # Hide row labels
  show_colnames = FALSE,  # Hide column labels
  fontsize = 30,
  annotation_legend = T,
  border_color = NA,
  annotation_legend_side = "left",
  width = 16, 
  height = 14,
  angle_col = 90,
  fontsize_col = 18,
  fontsize_row = 12,
  main = 'Regulon activity correlation matrix: Hierarchical Clustering',
  #filename = paste0(savepath, 'pheatmap_HC_top_layer_DM_imputed.pdf')
  
)

```


















```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

```













```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = ''}

```



